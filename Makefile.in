#=====================================================================
#
#               S p e c f e m 3 D  V e r s i o n  1 . 4
#               ---------------------------------------
#
#                 Dimitri Komatitsch and Jeroen Tromp
#    Seismological Laboratory - California Institute of Technology
#         (c) California Institute of Technology July 2005
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
#=====================================================================
#
# United States Government Sponsorship Acknowledged.
#

# @configure_input@

FC = @FC@
FCFLAGS = #@FCFLAGS@
MPIFC = @MPIFC@
MPILIBS = @MPILIBS@
FLAGS_CHECK = @FLAGS_CHECK@
FLAGS_NO_CHECK = @FLAGS_NO_CHECK@
FCFLAGS_f90 = @FCFLAGS_f90@

FCCOMPILE_CHECK =@FCENV@ ${FC} ${FCFLAGS} $(FLAGS_CHECK)
FCCOMPILE_NO_CHECK =@FCENV@ ${FC} ${FCFLAGS} $(FLAGS_NO_CHECK)
MPIFCCOMPILE_CHECK =@FCENV@ ${MPIFC} ${FCFLAGS} $(FLAGS_CHECK)
MPIFCCOMPILE_NO_CHECK =@FCENV@ ${MPIFC} ${FCFLAGS} $(FLAGS_NO_CHECK)
@COND_MPI_TRUE@FCLINK = $(MPIFCCOMPILE_NO_CHECK)
@COND_MPI_FALSE@FCLINK = $(FCCOMPILE_NO_CHECK)

CC = @CC@
CFLAGS = @CFLAGS@ $(CPPFLAGS)
CPPFLAGS = @CPPFLAGS@ $(COND_MPI_CPPFLAGS)
@COND_MPI_TRUE@COND_MPI_CPPFLAGS = -DWITH_MPI
@COND_MPI_FALSE@COND_MPI_CPPFLAGS =

AR = ar
ARFLAGS = cru
RANLIB = ranlib

##.PHONY: clean default all backup bak generate_databases specfem3D meshfem3D

####
#### targets
####

# default targets for the pure Fortran version
@COND_PYRE_FALSE@DEFAULT = \
@COND_PYRE_FALSE@	xdecompose_mesh_SCOTCH \
@COND_PYRE_FALSE@	meshfem3D \
@COND_PYRE_FALSE@	generate_databases \
@COND_PYRE_FALSE@	specfem3D \
@COND_PYRE_FALSE@	$(EMPTY_MACRO)

# @COND_PYRE_FALSE@	combine_vol_data \
# @COND_PYRE_FALSE@	combine_surf_data \
# @COND_PYRE_FALSE@	convolve_source_timefunction \

default: $(DEFAULT)

all: default

required: bin lib obj

backup:
	cp *f90 *h README_SPECFEM3D in_data_files/Par_file* Makefile go_generate_databases* go_mesher* go_solver* mymachines bak

bak: backup

mesh : meshfem3D
gen : generate_databases
spec : specfem3D
dec : decompose_mesh_SCOTCH

generate_databases: xgenerate_databases
specfem3D: xspecfem3D
meshfem3D: xmeshfem3D
decompose_mesh_SCOTCH: xdecompose_mesh_SCOTCH
convolve_source_timefunction: xconvolve_source_timefunction
create_movie_shakemap_AVS_DX_GMT: xcreate_movie_shakemap_AVS_DX_GMT
combine_vol_data: xcombine_vol_data
combine_surf_data: xcombine_surf_data

bin:
	mkdir -p bin

lib:
	mkdir -p lib

obj:
	mkdir -p obj

reqmesh:
	(cd obj; mkdir -p mesh)

reqspec:
	(cd obj; mkdir -p spec)

reqdec:
	(cd obj; mkdir -p dec)

reqgen :
	(cd obj; mkdir -p gen)

xmeshfem3D:  required reqmesh
	     (cd src/meshfem3D; make)

xspecfem3D:  required reqspec
	     (cd src/specfem3D; make specfem3D)

xgenerate_databases:  required reqgen
	     (cd src/generate_databases ; make generate_databases)

xdecompose_mesh_SCOTCH:  required reqdec
	     (cd src/decompose_mesh_SCOTCH ; make)

xcreate_movie_shakemap_AVS_DX_GMT: required
	(cd src/specfem3D ; make xcreate_movie_shakemap_AVS_DX_GMT)

xcombine_vol_data: required
	(cd src/specfem3D ; make xcombine_vol_data)

xcombine_surf_data: required
	(cd src/specfem3D ; make xcombine_surf_data)

xconvolve_source_timefunction: required
	(cd src/specfem3D ; make xconvolve_source_timefunction)

clean: required
	(rm -rf bin lib obj src/meshfem3D/*.mod src/generate_databases/*.mod src/specfem3D/*.mod)


help:
	@echo "usage: make [executable]"
	@echo ""
	@echo "supported executables:"
	@echo "    xgenerate_databases"
	@echo "    xspecfem3D"
	@echo "    xmeshfem3D"
	@echo "    xdecompose_mesh_SCOTCH"
	@echo "    xconvolve_source_timefunction"
	@echo "    xcreate_movie_shakemap_AVS_DX_GMT"
	@echo "    xcombine_vol_data"
	@echo "    xcombine_surf_data"
	@echo ""

